TOKEN "read_pipes" READ

DESCRIPTION >
    Get detailed LLM messages with filters

NODE llm_messages_node
SQL >
    %
    {% if defined(embedding) %}
        with 
        if(length(embedding) > 0, cosineDistance(embedding, {{ Array(embedding, 'Float32') }}), 1.0) as similarity
    {% end %}
    SELECT
        timestamp,
        organization,
        project,
        environment,
        user,
        chat_id,
        model,
        provider,
        prompt_tokens,
        completion_tokens,
        total_tokens,
        duration,
        cost,
        response_status,
        exception
    FROM llm_events
    WHERE 1
        {% if defined(organization) %}
        AND organization = {{String(organization, '')}}
        {% end %}
        {% if defined(project) %}
        AND project = {{String(project, '')}}
        {% end %}
        {% if defined(environment) %}
        AND environment = {{String(environment, '')}}
        {% end %}
        {% if defined(user) %}
        AND user = {{String(user, '')}}
        {% end %}
        {% if defined(model) %}
        AND model = {{String(model, '')}}
        {% end %}
        {% if defined(provider) %}
        AND provider = {{String(provider, '')}}
        {% end %}
        {% if defined(chat_id) %}
        AND chat_id = {{String(chat_id, '')}}
        {% end %}
        {% if defined(start_date) %}
        AND timestamp >= {{DateTime(start_date)}}
        {% else %}
        AND timestamp >= now() - interval 7 day
        {% end %}
        {% if defined(end_date) %}
        AND timestamp < {{DateTime(end_date)}}
        {% else %}
        AND timestamp < now()
        {% end %}
        {% if defined(embedding) %}
        AND cosineDistance(embedding, {{ Array(embedding, 'Float32') }}) > {{ Float64(similarity_threshold, 0.7) }}
        {% end %}
    {% if defined(embedding) %}
      ORDER BY similarity DESC
    {% else %}
        ORDER BY timestamp DESC
    {% end %}
    LIMIT {{Int32(limit, 100)}}

TYPE endpoint
